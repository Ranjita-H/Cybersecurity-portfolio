import csv
import re
import requests
import time
import pandas as pd

# NVD API URL
NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cve/1.0/"

def extract_cves(text):
    """
    Extracts CVE IDs from a given text.
    """
    return re.findall(r"CVE-\d{4}-\d{4,7}", text)

def query_nvd(cve_id):
    """
    Queries NVD API for a CVE description.
    """
    try:
        response = requests.get(NVD_API_URL + cve_id)
        if response.status_code == 200:
            data = response.json()
            desc = data["result"]["CVE_Items"][0]["cve"]["description"]["description_data"][0]["value"]
            return desc
        else:
            return "No description found (API error)."
    except Exception as e:
        return f"Error: {e}"

def main():
    csv_file = "../scan_data/sample_scan.csv"
    cve_records = []

    with open(csv_file, newline='', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            plugin_output = row.get("Plugin Output", "")
            cves = extract_cves(plugin_output)
            for cve in cves:
                print(f"Querying {cve}...")
                desc = query_nvd(cve)
                cve_records.append({
                    "Host": row.get("Host"),
                    "Port": row.get("Port"),
                    "Severity": row.get("Severity"),
                    "CVE": cve,
                    "Description": desc
                })
                time.sleep(1)  # Avoid rate limiting

    # Convert to DataFrame
    df = pd.DataFrame(cve_records)
    df.to_excel("../reports/nessus_cve_report.xlsx", index=False)
    print("Report generated: nessus_cve_report.xlsx")

if __name__ == "__main__":
    main()
